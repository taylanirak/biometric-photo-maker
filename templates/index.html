<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Photo Maker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Manrope', sans-serif; background: linear-gradient(180deg, #f1f2f5 0%, #e4e6eb 45%, #d8dbe2 100%); color: #111; }
        .slide-container { position: relative; width: 100%; height: 100%; overflow: hidden; border-radius: 9999px; background: #0f0f0f; }
        .slider-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: inherit; }
        /* Foreground covers full area; clipping controlled via CSS variable --clip */
        .slider-foreground { position: absolute; inset: 0; width: 100%; height: 100%; overflow: hidden; border-radius: inherit; --clip: 50%; clip-path: polygon(0 0, var(--clip) 0, var(--clip) 100%, 0 100%); }
        .loader-dot { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        .gradient-silver { background: linear-gradient(90deg, #6ec6f0, #a3d4f5, #6ec6f0); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .heading-navy { color: #2F92DF; }
        .section-divider { border-color: #cbd5e1; box-shadow: inset 0 6px 12px rgba(0,0,0,0.04), inset 0 -6px 12px rgba(0,0,0,0.04); }
        .divider-line { border-color: #cbd5e1 !important; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* Reveal animations */
        .reveal-title { opacity: 0; transform: translateY(40px); animation: heroFadeUp 0.9s ease-out 0.1s forwards; }
        .reveal-sub { opacity: 0; transform: translateY(20px); animation: heroFadeUp 0.8s ease-out 0.25s forwards; }
        .slider-zoom { opacity: 0; transform: perspective(1200px) translateY(30px) scale(0.9) rotateX(4deg); animation: sliderReveal 1s cubic-bezier(0.22, 1, 0.36, 1) 0.35s forwards; }

        @keyframes heroFadeUp {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes sliderReveal {
            0% { opacity: 0; transform: perspective(1200px) translateY(40px) scale(0.88) rotateX(6deg); }
            60% { opacity: 1; transform: perspective(1200px) translateY(-6px) scale(1.02) rotateX(0deg); }
            100% { opacity: 1; transform: perspective(1200px) translateY(0) scale(1) rotateX(0deg); }
        }

        @media (prefers-reduced-motion: reduce) {
            .reveal-title, .reveal-sub, .slider-zoom { animation: none; opacity: 1 !important; transform: none !important; }
        }
    </style>
</head>
<body class="antialiased selection:bg-[#2F92DF] selection:text-white">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 transition-all duration-300 backdrop-blur-md bg-[#F4F4F2]/90 border-b border-gray-200/50"
         style="box-shadow: 0 8px 22px rgba(0,0,0,0.08);">
        <div class="max-w-[90rem] mx-auto px-4 sm:px-8 py-4 flex justify-between items-center">
            <a href="/" class="text-xl tracking-tight font-semibold flex items-center gap-2 text-[#2F92DF]">
                <div class="w-3 h-3 bg-[#2F92DF] rounded-full"></div>
                biometric(ai)
            </a>
            <div class="hidden md:flex gap-8 items-center text-sm font-medium text-gray-600">
                <a href="#how-it-works" class="hover:text-[#2F92DF] text-[#2F92DF] transition-colors">Process</a>
                <a href="#compliance" class="hover:text-[#2F92DF] text-[#2F92DF] transition-colors">Compliance</a>
                <a href="#pricing" class="hover:text-[#2F92DF] text-[#2F92DF] transition-colors">Pricing</a>
            </div>
            <a href="#upload-section" class="group flex items-center gap-3 bg-white pl-5 pr-1 py-1 rounded-full border border-gray-200 hover:border-gray-300 transition-all shadow-sm">
                <span class="text-xs font-semibold uppercase tracking-wider">Start Now</span>
                <div class="w-8 h-8 rounded-full bg-[#2F92DF] text-white flex items-center justify-center group-hover:scale-105 transition-transform">
                    <i data-lucide="arrow-up-right" class="w-4 h-4"></i>
                </div>
            </a>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="pt-32 pb-20 px-4 sm:px-8 max-w-[90rem] mx-auto">
        <div class="flex flex-col items-center text-center mb-16">
            <h1 class="reveal-title heading-navy text-5xl md:text-7xl lg:text-8xl font-medium tracking-tight leading-[1.1] mb-8">
                Compliance in <br class="hidden md:block">
                <span class="gradient-silver">every single</span> pixel.
            </h1>
            <p class="reveal-sub text-lg md:text-xl text-gray-600 max-w-2xl font-light leading-relaxed">
                Upload your casual photo and get a strictly compliant biometric passport photo in seconds. Engineered for acceptance, designed for humans.
            </p>
        </div>

        <!-- Before/After Slider Component -->
        <div class="slider-zoom relative w-full max-w-lg mx-auto aspect-square md:aspect-[4/3] rounded-[3rem] overflow-hidden shadow-2xl border-4 border-[#2F92DF] no-select" id="comparison-container">
            <img src="/static/processed/processed_photo-1544005313-94ddf0286df2.jpg" class="slider-image grayscale-0 object-cover" alt="Biometric Result">
            <div class="absolute top-6 right-6 bg-white/90 backdrop-blur px-4 py-1 rounded-full text-xs font-semibold text-[#2F92DF] z-0">BIOMETRIC</div>
            <div class="slider-image slider-foreground absolute inset-0 z-10" id="foreground-image">
                <img src="/static/processed/cropped_photo-1544005313-94ddf0286df2.jpg" class="absolute inset-0 w-[100vw] max-w-lg h-full object-cover" style="width: 100%; max-width: none;" alt="Original">
                <div class="absolute top-6 left-6 bg-black/80 backdrop-blur px-4 py-1 rounded-full text-xs font-semibold text-white">ORIGINAL</div>
            </div>
            <div class="absolute inset-y-0 z-20 cursor-ew-resize" style="left: 50%;" id="slider-handle">
                <div id="handle-line" class="absolute top-0 bottom-0 w-1 bg-white shadow-lg -ml-0.5 transition-opacity"></div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-[#2F92DF] rounded-full flex items-center justify-center text-white shadow-xl hover:scale-110 transition-transform">
                    <i data-lucide="chevrons-left-right" class="w-5 h-5"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- Upload Section -->
    <section id="upload-section" class="py-20 border-t border-gray-300 section-divider">
        <div class="max-w-[90rem] mx-auto px-4 sm:px-8">
            <div class="flex justify-between items-start mb-12">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center">
                        <i data-lucide="arrow-down" class="w-4 h-4 text-[#2F92DF]"></i>
                    </div>
                    <h2 class="text-2xl font-medium tracking-tight heading-navy border-b-2 border-gray-300 pb-1 inline-block">Upload</h2>
                </div>
                <!-- removed (01) -->
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                <div class="lg:col-span-4">
                    <h3 class="text-4xl font-medium tracking-tight mb-6 heading-navy">Drop it like it's hot.</h3>
                    <p class="text-gray-500 font-light text-lg mb-8">
                        We accept PNG, JPG, JPEG. Don't worry about the background or lighting, our AI engine handles the heavy lifting.
                    </p>
                    <ul class="space-y-3">
                        <li class="flex items-center gap-3 text-sm text-gray-700">
                            <i data-lucide="check" class="w-4 h-4 text-[#2F92DF]"></i> Face recognized instantly
                        </li>
                        <li class="flex items-center gap-3 text-sm text-gray-700">
                            <i data-lucide="check" class="w-4 h-4 text-[#2F92DF]"></i> Background removal
                        </li>
                        <li class="flex items-center gap-3 text-sm text-gray-700">
                            <i data-lucide="check" class="w-4 h-4 text-[#2F92DF]"></i> Lighting enhancement
                        </li>
                    </ul>
                </div>

                <div class="lg:col-span-8">
                    <div id="drop-zone" class="relative group w-full aspect-video md:aspect-[2/1] border border-dashed border-gray-400 rounded-[2rem] bg-white flex flex-col items-center justify-center hover:bg-gray-50 transition-all cursor-pointer overflow-hidden">
                        <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/png, image/jpeg, image/jpg, image/gif">
                        <div class="z-10 flex flex-col items-center transition-transform group-hover:scale-105 duration-300 pointer-events-none">
                            <div class="w-20 h-20 bg-[#F4F4F2] rounded-full flex items-center justify-center mb-6">
                                <i data-lucide="upload-cloud" class="w-8 h-8 text-[#2F92DF]"></i>
                            </div>
                            <p class="text-xl font-medium mb-2">Drag & Drop or Click to Upload</p>
                            <p class="text-sm text-gray-400">Supports JPG, PNG up to 10MB</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features -->
    <section id="how-it-works" class="py-20">
        <div class="max-w-[90rem] mx-auto px-4 sm:px-8">
            <div class="flex justify-between items-start mb-12">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center">
                        <i data-lucide="arrow-right" class="w-4 h-4 text-[#2F92DF]"></i>
                    </div>
                    <h2 class="text-2xl font-medium tracking-tight heading-navy border-b-2 border-gray-300 pb-1 inline-block">Process</h2>
                </div>
                <!-- removed (02) -->
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-8 rounded-[2rem] border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="w-12 h-12 bg-[#F4F4F2] rounded-full flex items-center justify-center mb-6">
                        <i data-lucide="crop" class="w-5 h-5 text-black"></i>
                    </div>
                    <h3 class="text-xl font-medium mb-3 heading-navy">Intelligent Crop</h3>
                    <p class="text-sm text-gray-500 font-light leading-relaxed">
                        Our algorithm identifies facial landmarks to center and crop your photo to strict ICAO standards.
                    </p>
                </div>
                <div class="bg-white p-8 rounded-[2rem] border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="w-12 h-12 bg-[#F4F4F2] rounded-full flex items-center justify-center mb-6">
                        <i data-lucide="eraser" class="w-5 h-5 text-black"></i>
                    </div>
                    <h3 class="text-xl font-medium mb-3 heading-navy">Background Erase</h3>
                    <p class="text-sm text-gray-500 font-light leading-relaxed">
                        Cluttered living room? Gone. We replace any background with a compliant, uniform off-white or white.
                    </p>
                </div>
                <div class="bg-white p-8 rounded-[2rem] border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="w-12 h-12 bg-[#F4F4F2] rounded-full flex items-center justify-center mb-6">
                        <i data-lucide="sparkles" class="w-5 h-5 text-black"></i>
                    </div>
                    <h3 class="text-xl font-medium mb-3 heading-navy">Enhance & Verify</h3>
                    <p class="text-sm text-gray-500 font-light leading-relaxed">
                        Subtle lighting correction and an automated checklist to ensure your application isn't rejected.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <section class="bg-[#111] text-white py-32 rounded-t-[3rem] mt-20">
        <div class="max-w-[90rem] mx-auto px-4 sm:px-8">
            <div class="flex flex-col md:flex-row justify-between items-end gap-12">
                <div class="max-w-2xl">
                    <h2 class="text-5xl md:text-7xl font-medium tracking-tight mb-8">
                        Ready to get <br> <span class="text-gray-500">verified?</span>
                    </h2>
                    <p class="text-xl font-light text-gray-400 max-w-lg mb-12">
                        No templates, no manual editing, just pure code doing the work. Get your biometric photo today.
                    </p>
                    <a href="#upload-section" class="inline-flex items-center gap-4 group">
                        <div class="bg-white text-black px-8 py-4 rounded-full font-medium tracking-wide">
                            Start Upload
                        </div>
                        <button type="button" onclick="window.scrollTo({top: 0, behavior: 'smooth'});" class="w-14 h-14 bg-[#2F92DF] rounded-full flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                            <i data-lucide="arrow-up" class="w-6 h-6"></i>
                        </button>
                    </a>
                </div>
                <!-- Removed backend status display -->
            </div>
            <div class="border-t border-gray-800 mt-20 pt-8 flex flex-col md:flex-row justify-between items-center text-sm text-gray-500">
                <p>Â© 2024 Biometric(ai). All rights reserved.</p>
                <div class="flex gap-6 mt-4 md:mt-0">
                    <a href="#" class="hover:text-white">Privacy</a>
                    <a href="#" class="hover:text-white">Terms</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Processing Modal -->
    <div id="processing-modal" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md p-8 rounded-[2rem] shadow-2xl m-4 transform scale-95 transition-transform duration-300" id="processing-content">
            <h3 class="text-2xl font-medium tracking-tight mb-8 text-center">Processing Photo</h3>
            <div class="space-y-6">
                <div class="step-item flex items-center gap-4 text-gray-400" id="step-1">
                    <div class="w-8 h-8 rounded-full border border-current flex items-center justify-center shrink-0">
                        <i data-lucide="crop" class="w-4 h-4"></i>
                    </div>
                    <span class="font-medium">Cropping to dimensions</span>
                    <div class="ml-auto loader-dot hidden"><div class="w-2 h-2 bg-[#2F92DF] rounded-full"></div></div>
                </div>
                <div class="step-item flex items-center gap-4 text-gray-400" id="step-2">
                    <div class="w-8 h-8 rounded-full border border-current flex items-center justify-center shrink-0">
                        <i data-lucide="eraser" class="w-4 h-4"></i>
                    </div>
                    <span class="font-medium">Removing background</span>
                    <div class="ml-auto loader-dot hidden"><div class="w-2 h-2 bg-[#2F92DF] rounded-full"></div></div>
                </div>
                <div class="step-item flex items-center gap-4 text-gray-400" id="step-3">
                    <div class="w-8 h-8 rounded-full border border-current flex items-center justify-center shrink-0">
                        <i data-lucide="wand-2" class="w-4 h-4"></i>
                    </div>
                    <span class="font-medium">Enhancing quality</span>
                    <div class="ml-auto loader-dot hidden"><div class="w-2 h-2 bg-[#2F92DF] rounded-full"></div></div>
                </div>
            </div>
            <div class="mt-8 text-center text-xs text-gray-400 font-mono">PLEASE WAIT...</div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="fixed inset-0 z-[70] bg-[#F4F4F2] hidden overflow-y-auto">
        <div class="min-h-screen flex flex-col">
            <div class="flex justify-between items-center p-6 md:p-8 border-b border-gray-200 bg-white sticky top-0 z-10">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="font-medium">Processing Complete</span>
                </div>
                <button onclick="closeResultModal()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="flex-1 max-w-[90rem] mx-auto w-full p-6 md:p-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 h-full">
                    <div class="bg-white rounded-[2rem] p-4 shadow-sm border border-gray-200 flex items-center justify-center h-fit">
                        <img id="result-image" src="" alt="Processed" class="rounded-xl w-full max-w-md shadow-inner bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-gray-50">
                    </div>
                    <div class="flex flex-col justify-center">
                        <h2 class="text-4xl font-medium tracking-tight mb-2">Check passed.</h2>
                        <p class="text-gray-500 font-light text-lg mb-8">Your photo meets the initial biometric standards.</p>
                        <div class="bg-white rounded-2xl p-6 mb-8 border border-gray-100">
                            <ul class="space-y-4">
                                <li class="flex items-center gap-3">
                                    <div class="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                        <i data-lucide="check" class="w-3 h-3"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-700">Face geometry detected</span>
                                </li>
                                <li class="flex items-center gap-3">
                                    <div class="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                        <i data-lucide="check" class="w-3 h-3"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-700">Single subject verified</span>
                                </li>
                                <li class="flex items-center gap-3">
                                    <div class="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                        <i data-lucide="check" class="w-3 h-3"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-700">Dimensions: 35x45mm (Adjusted)</span>
                                </li>
                                <li class="flex items-center gap-3">
                                    <div class="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                        <i data-lucide="check" class="w-3 h-3"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-700">Eyes open, visible</span>
                                </li>
                            </ul>
                        </div>
                        <div class="bg-[#111] text-white p-6 rounded-2xl mb-8 flex justify-between items-center">
                            <div>
                                <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Total</p>
                                <p class="text-2xl font-semibold">$9.99</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-400">Expert verification included</p>
                            </div>
                        </div>
                        <div class="flex flex-col gap-4">
                            <button id="checkout-btn" class="w-full bg-[#2F92DF] text-white py-4 rounded-full font-medium tracking-wide hover:shadow-lg hover:shadow-blue-200 transition-all flex items-center justify-center gap-2 group">
                                Proceed to Checkout
                                <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                            </button>
                            <button onclick="resetFlow()" class="w-full bg-white text-gray-600 border border-gray-200 py-4 rounded-full font-medium tracking-wide hover:bg-gray-50 transition-colors">
                                Retake / Upload Another
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const container = document.getElementById('comparison-container');
        const foreground = document.getElementById('foreground-image');
        const handle = document.getElementById('slider-handle');
        const handleLine = document.getElementById('handle-line');
        let isDragging = false;

        const updateSlider = (x) => {
            const rect = container.getBoundingClientRect();
            let percentage = ((x - rect.left) / rect.width) * 100;
            percentage = Math.max(0, Math.min(100, percentage));
            // Use clip-path variable to keep rounded corners on foreground
            foreground.style.setProperty('--clip', `${percentage}%`);
            handle.style.left = `${percentage}%`;
            // Hide the handle line when at extremes to avoid visible seam
            if (percentage <= 0.5 || percentage >= 99.5) {
                handleLine.style.opacity = '0';
            } else {
                handleLine.style.opacity = '1';
            }
        };

        // Use pointer events to keep drag active even when hitting edges
        container.addEventListener('pointerdown', (e) => {
            isDragging = true;
            container.setPointerCapture(e.pointerId);
            document.body.style.userSelect = 'none';
            updateSlider(e.clientX);
        });

        container.addEventListener('pointermove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            updateSlider(e.clientX);
        });

        container.addEventListener('pointerup', (e) => {
            isDragging = false;
            container.releasePointerCapture(e.pointerId);
            document.body.style.userSelect = '';
        });

        container.addEventListener('pointercancel', (e) => {
            isDragging = false;
            try { container.releasePointerCapture(e.pointerId); } catch (_) {}
            document.body.style.userSelect = '';
        });

        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const processingModal = document.getElementById('processing-modal');
        const processingContent = document.getElementById('processing-content');
        const resultModal = document.getElementById('result-modal');
        const resultImage = document.getElementById('result-image');
        const checkoutBtn = document.getElementById('checkout-btn');
        let currentProcessedUrl = '';

        fileInput.addEventListener('change', handleUpload);

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-gray-50');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('bg-gray-50'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-gray-50');
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleUpload({ target: { files: e.dataTransfer.files } });
            }
        });

        async function safeJsonParse(response) {
            const text = await response.text();
            try {
                return { data: JSON.parse(text), raw: text };
            } catch (_) {
                return { data: null, raw: text };
            }
        }

        async function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('File type not allowed. Please upload PNG, JPG, or GIF.');
                return;
            }

            showProcessing();
            const formData = new FormData();
            formData.append('file', file);

            try {
                const uploadRes = await fetch('/upload', { method: 'POST', body: formData });
                const { data: uploadData, raw: uploadRaw } = await safeJsonParse(uploadRes);
                if (!uploadRes.ok || !uploadData || uploadData.error) {
                    throw new Error((uploadData && uploadData.error) || uploadRaw || 'Upload failed');
                }

                completeStep(1);
                activateStep(2);

                await new Promise((r) => setTimeout(r, 400));

                const processRes = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filepath: uploadData.filepath }),
                });
                const { data: processData, raw: processRaw } = await safeJsonParse(processRes);
                if (!processRes.ok || !processData || processData.error) {
                    const message = (processData && processData.error) || processRaw || 'Processing failed, please retry later.';
                    throw new Error(message);
                }

                completeStep(2);
                activateStep(3);
                await new Promise((r) => setTimeout(r, 600));
                completeStep(3);

                // Prefer watermarked/blurred preview for display; keep enhanced for checkout
                const displayImage = processData.watermarked_image_url || processData.processed_image_url || processData.enhanced_image_url;
                currentProcessedUrl = processData.enhanced_image_url || processData.processed_image_url;
                showResult(displayImage);
            } catch (error) {
                alert(error.message);
                hideProcessing();
                fileInput.value = '';
            }
        }

        function showProcessing() {
            processingModal.classList.remove('hidden');
            setTimeout(() => {
                processingModal.classList.remove('opacity-0');
                processingContent.classList.remove('scale-95');
                processingContent.classList.add('scale-100');
            }, 10);
            resetStep(1);
            resetStep(2);
            resetStep(3);
            activateStep(1);
        }

        function hideProcessing() {
            processingModal.classList.add('opacity-0');
            processingContent.classList.remove('scale-100');
            processingContent.classList.add('scale-95');
            setTimeout(() => processingModal.classList.add('hidden'), 300);
        }

        function activateStep(num) {
            const el = document.getElementById(`step-${num}`);
            el.classList.remove('text-gray-400');
            el.classList.add('text-[#111]');
            el.querySelector('.loader-dot').classList.remove('hidden');
        }

        function completeStep(num) {
            const el = document.getElementById(`step-${num}`);
            el.querySelector('.loader-dot').classList.add('hidden');
            const iconContainer = el.querySelector('div');
            iconContainer.classList.remove('border-current');
            iconContainer.classList.add('bg-green-500', 'border-green-500', 'text-white');
            iconContainer.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
            lucide.createIcons();
        }

        function resetStep(num) {
            const el = document.getElementById(`step-${num}`);
            el.className = 'step-item flex items-center gap-4 text-gray-400';
            const iconName = num === 1 ? 'crop' : num === 2 ? 'eraser' : 'wand-2';
            const label = num === 1 ? 'Cropping to dimensions' : num === 2 ? 'Removing background' : 'Enhancing quality';
            el.innerHTML = `
                <div class="w-8 h-8 rounded-full border border-current flex items-center justify-center shrink-0">
                    <i data-lucide="${iconName}" class="w-4 h-4"></i>
                </div>
                <span class="font-medium">${label}</span>
                <div class="ml-auto loader-dot hidden"><div class="w-2 h-2 bg-[#2F92DF] rounded-full"></div></div>
            `;
            lucide.createIcons();
        }

        function showResult(url) {
            hideProcessing();
            resultImage.src = url;
            resultModal.classList.remove('hidden');
        }

        function closeResultModal() {
            resultModal.classList.add('hidden');
            fileInput.value = '';
        }

        function resetFlow() {
            closeResultModal();
            document.getElementById('upload-section').scrollIntoView({ behavior: 'smooth' });
        }

        checkoutBtn.addEventListener('click', () => {
            if (currentProcessedUrl) {
                window.location.href = '/payment?image_path=' + encodeURIComponent(currentProcessedUrl);
            }
        });

        lucide.createIcons();
    </script>
</body>
</html>
